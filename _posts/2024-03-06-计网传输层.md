---
title: 计网传输层
author: lonelywatch
date: 2024-03-5 15:14
categories: [计网]
tags: [INTERNET] 
---

TCP是**面向连接的运输层**协议，使用前必须建立连接，使用后必须释放连接，有这么几个特点：

- 点对点:使用套接字(IP地址，端口)描述TCP连接的双方。
- 可靠交付：无差错传输，不重不漏，按序到达
- 全双工通信: 双方任何时刻可发送数据
- 面向字节流: TCP将数据看作为无结构的字节流。

TCP会根据对方给出的窗口值与当前的拥塞程度来决定其报文数据长度。

---

TCP使用一些可靠协议来使用不可靠但尽最大努力传送的IP层服务提供可靠的传输层服务。

1. 停止等待协议： 
  发送方每发送一个包，就等待接收方返回确认，否则超时重传。

  接收方可能没有收到，可能检测包出现差错，都不需要返回确认，否则必须返回确认。

  发送方需要对包编号，并且保留发送但未确认的包的副本，超时计时器的重传时间应该要比平均往返时间要适当地大一些。

  这种协议利用率较低，可以使用流水线传输，通过连续发送多个分组的方式来提高信道利用率。

2. 连续ARQ协议：使用滑动窗口。

3. 滑动窗口协议

​	发送方与接收方使用环形缓冲各自维护一个窗口，发送窗口中的数据表示发送方可以放松的数据，，在该窗口内有一个指针，指针左侧到窗口后沿表示已发送但未收到确认的数据，右侧到窗口前沿表示未发送的数据，当收到一部分数据的确认报文后就将窗口后沿前移到指针处，已发送但未确认的数据同样需要保留其副本用于超时重传。

​	接收方通常在接收一段数据后发送这一段数据的ACK报文给发送方，如果不连续则会存储到达数据，等待缺失数据（或者开启SACK选项，确认收到的部分数据段）。

​	发送方使用一种启发的自适应算法，记录每次报文往返时间RTT，求所有报文加权往返时间RTTs，超时重传的时间应该比该时间稍大一些，不应该使用超时重传报文的RTT作为计算RTTs的样本。

TCP首部前20字节固定，后`4n`字节可选。固定字段主要有：

- 源端口与目的端口
- Seq num 序号：本报文中数据段的第一个字节的序号
- Ack num 确认号：期待下一次报文数据段的第一个字节序号
- 数据偏移: 本报文中数据段距离报文起始处的偏移。
- Ack：只有有了`Ack`位，确认号才有效。
- PSH: 希望尽快收到对方的响应
- RST: 重新建立连接
- SYN:用来建立连接时同步序号: SYN为1而ACK为0表示为连接请求，都为1则表示同意连接，
- FIN:终止，用来释放连接，FIN为1表示该报文的发送方数据传输完成，要求释放连接。
- 窗口值: 从本报文的确认号算起，允许对方发送的数据量，作为发送方设置发送窗口的依据。

---

TCP有流量控制功能，就是让发送方不要发太快，让接收方来得及接收。

发送方的发送窗口不能超过接收方报文给出的接收窗口数值。为了提高传送的效率，也可以使用Nagle算法: 将发送缓存的第一个字节先发送，收到确认后发送所有字节（这里按照返回报文的窗口大小和MSS来发送），然后将剩余字节继续缓冲；当到达的数据超过窗口一半时，就立即发送一个报文段。

糊涂窗口综合征指的是接收缓冲已满，但是进程处理数据很慢，导致每次的确认报文中的窗口值总是很小，这时需要停止发送一段时间来让接收方消耗部分接收缓冲，等待其接收缓冲有一般的空闲空间。

---

TCP具有拥塞控制功能。拥塞指的是网络中的需求超过了可用资源(全局性过程)；拥塞控制则是防止过多数据注入到网络中。



TCP主要有四种拥塞控制的算法，包括：

- 慢开始: 由小到大逐渐增加发送窗口大小与拥塞窗口数值。(cwnd拥塞窗口 < ssthresh慢开始门限)
- 拥塞避免:  让拥塞窗口缓慢增大，每经过一个RTT就增加cwnd 一个1。 主要表现为cwnd线性规律缓慢增长。
- 快重传: 一旦收到3个重复确认，就立刻重传。(接收方如果没有收到对应序号分组在之后每次接收到其他包就会一直发送之前的确认分组)
- 快恢复：发送方调整慢开始门限。

发送方维护一个拥塞窗口的变量，让发送窗口的大小总是等于该变量。其原则是：只要没有拥塞，久长时增大，否则减少。（通过超时来判断网络拥塞）





