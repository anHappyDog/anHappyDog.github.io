---
title: 计网运输层
author: lonelywatch
date: 2022-12-23 22:14 +0800
categories: [BUAA,计网]
tags: [计网]
---

### 运输层

​		从应用层，到运输层，再到网络层，再到其他，什么是自顶向下啊（战术后仰。

​		总的来说，网络层是主机与主机进行通信，而主机上有许多进程，运输层则是主机中进程之间的通信。

​		我们将运输层分组简称为**报文段**。

​		因特网网络层协议有一个名字叫IP，**网络协议**。其服务模型为**尽力而为交付服务**。但它不确保报文段的交付等等，也称为**不可靠服务**。

​		主机间交付扩展到进程间交付称为运输层的**多路复用**和**多路分解**。

从运输层报文段中的数据交付到正确的套接字的工作为多路分解，从各套接字中收集数据块，并为数据块封装上首部信息从而生成报文段并传送到网络层则为多路复用。

​		每一个套接字都有唯一标识符，每个报文段都有特殊字段来指示将要交付到的套接字，分别为**源端口号字段**，**目的端口号字段**，报文段和其他的一些字段。事实上UDP套接字是由（目的地IP地址，目的地端口号）二元组标识的，而TCP套接字则是由（源IP地址，源端口号，目的IP地址，目的端口号）四元组标识的，运输层根据这些来进行多路复用和多路分解。

​		TCP提供了可靠数据链接但并不总是首选。TCP拥有拥塞机制，而UDP直接将数据打包进报文段。TCP需要建立三次握手而UDP不需要任何准备就可以进行数据传输。TCP需要维护连接状态，而UDP不维护连接状态，也没必要跟踪参数。

---

### UDP报文段结构

​	除开后面的数据字段，UDP报文段前面包括**源端口号**，**目的端口号**，**长度**，和**校验和**。每个字段2字节，故共8字节，32比特。

#### UDP检验和

​	UDP发送方将所有的16比特字的和进行反码运算，遇到溢出回卷。检验时所有的16比特字加起来应该全为1，否则就是出错。

### 可靠数据的传输

#### 经完全可靠信道的可靠数据传输: rdt1.0

​		在这种情况下接收方不需要向发送方发送任何反馈。

#### 经具有比特差错的可靠数据传输: rdt2.0

​		分组中的比特有可能出现受损的情况，通过使用**肯定确定**和**否定确定**，这种重传机制的可靠数据传输协议被称为**自动重传请求协议**。需要进行**差错检测**，**接收方反馈**，**重传**三个功能。

​		接收方接收信号时根据是否完整接收数据发送ACK和NAK给发送方，发送方在收到ACK之前不会发送下一条数据，这种协议称为**停等**协议，与之对应的有**流水线**协议。

​		事实上，ACK信号也有可能出现受损，在ACK信号不明的情况下重传，是会有问题的，接收方如果是ACK的情况下可能会接收这一重发的数据，解决办法就是，在数据分组中添加对数据分组编号的字段，即将发送数据分组的**序号**，在这里只需要1位。

#### 经具有比特差错的丢包信道的可靠数据传输: rdt3.0

​		对于丢包，我们需要判断是否丢包，以及丢包后的措施。

​		我们通过等待来判断是否丢包。在某个时间之后如果没有收到ACK则重新发送该分组，这里可能会引入**冗余数据分组**，我们需要一个**倒计数定时器**，在发送时启动该定时器，然后判断是否丢包。

#### 流水线可靠数据传输协议

​		停等协议的时间利用率太低，产生了流水线可靠数据传输协议，即允许发送发发送多个分组而无须等待确认。

​		对于这种措施，我们需要增加序号范围，发送方和接收方也必须缓存一定的分组，还需要对没有传送好的分组进行一定的措施，包括**回退N步**和**选择重传**。

#### 回退N步

​		发送方维护一个长度为N的**窗口**，，窗口中有**已经发送并确认的分组**，**发送了但未确认的分组**，**即将发送的分组**，如果超时，则重新发送所有发送了但未确认的分组。

#### 选择重传

​		回退N步可能会使得很多不必要的重传，选择重传仅重传那些它怀疑未被接收方正确接收的分组，SR接收方只有当所有的分组收齐时（为了保持顺序），才会将分组传给上层。

#### 可靠数据传输机制

- 检验和: 检测分组中的比特错误
- 定时器: 判断是否超时，重传一个分组
- 序号:判断是否冗余，是否丢失
- 确认和否认确认:告诉发送方是否正确收到
- 窗口和流水线，提高利用率

### TCP

#### TCP报文段结构

​		TCP报文段由首部字段和一个数据字段构成，MSS限制了报文段数据字段的最大长度，当TCP发送一个大文件时，通常要分割成若干块。

​		TCP首部包括 源端口号，目的端口号，检验和字段，32位序号字段，16位接收窗口字段，4位首部长度字段，6位标志字段，可选变长的选项字段还有16位大的紧急数据指针字段。
