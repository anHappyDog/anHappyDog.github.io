---
title: 计网传输层
author: lonelywatch
date: 2024-4-22 21:28 +0800
categories: [INTERNET]
tags: [INTERNET]   
---

# 计网传输层

传输层向应用层提供通信服务，实现了可靠传输。与网络层相比，传输层提供了真正的端到端通信，即进程之间的逻辑协议，主要协议有TCP和UDP。

为了区分上层用户进程，TCP/IP协议使用16位整数作为端口号。比如HTTP服务使用80端口，HTTPS使用443端口，FTP使用21端口，SFTP使用22端口。

## UDP协议

UDP是不可靠传输的协议，具有以下特点：

- 无连接，也就是不需要建立连接
- 尽最大努力交付
- 面向报文
- 首部开销小，并且支持1v1,1v多以及多v多

### UDP报文格式

![image-20240602222433412](https://lonelywatch-1306651324.cos.ap-beijing.myqcloud.com/image-20240602222433412.png)

首部总共4字段，总计8字节：

- 源端口：源端口号2字节
- 目的端口: 目的端口号2字节
- 长度： UDP数据报长度2字节
- 校验和: UDP数据报校验和2字节

其中会有一个12字节的伪首部。整数在网络中通常使用大端。

### TCP协议

TCP是面向连接的传输层协议，具有如下特点：
- 面向连接，传输数据间前必须先建立连接，传输完后需要释放连接
- 每个TCP连接只能有两个端点
- 提供可靠的全双工服务
- 面向字节流

#### TCP报文长度

![image-20240603003054964](https://lonelywatch-1306651324.cos.ap-beijing.myqcloud.com/image-20240603003054964.png)

- 2字节源端口
- 2字节目的端口
- 4字节序号字段
- 4字节确认号字段
- 4b数据偏移
- 6b保留字段
- 1b紧急字段
- 1bACK字段
- 1bPSH字段
- 1bRST字段
- 1bSYN同步字段
- 1bFIN终止字段
- 2字节窗口大小，用于让对方设置发送窗口的依据

#### 可靠传输的实现

TCP基于滑动窗口协议实现可靠传输和流量控制，以字节为单位。

- 发送窗口
 - 在没有收到对方应答时，可连续把窗口内数据发送出去
 - 根据对方发送的窗口大小以及拥塞控制来确定窗口大小
 - 根据对方的TCP报文中的ACK NUMBER来让窗口滑动

![image-20240603003534694](https://lonelywatch-1306651324.cos.ap-beijing.myqcloud.com/image-20240603003534694.png)

> ACK NUMBER表示期望收到的数据报序号，表示之前的已收到。

- 接收窗口
 - 窗口内数据可接收
 - 窗口后沿以外则是已接受并交付的数据

TCP的可靠传输通过检验和与超时重传实现。

#### 超时重传

TCP每发送一个报文段，就设置一个计时器，超时则重传。TCP采取了一种自适应算法来计算超时重传时间。$RTT_{s} = (1 - a) * RTT_{s旧} + a * RTT$表示加权往返时间。往返重传时间应该略大于它。

#### 流量控制

目的：为了让发送方不发送过快，接收方来得及接收。

- TCP连接建立时，将接收窗口大小告知对方
- TCP报文含有窗口大小字段，用于告知对方接收窗口的剩余大小
- 发送窗口应该不大于对方的接收窗口。

为了避免TCP应答报文丢失，设计了一个持续计时器，一旦到时，则会发送一个零窗口探测报文，如果窗口为0则重新设置计时器。

#### 拥塞控制

![image-20240603004729053](https://lonelywatch-1306651324.cos.ap-beijing.myqcloud.com/image-20240603004729053.png)

TCP主要有4中拥塞控制方法：

- 慢启动：试探性地从小到大增加发送窗口，并且发送方维护一个拥塞窗口，其大小取决于网络的拥塞成都，让其发送窗口小于拥塞窗口与对方接收窗口的最小值。
    - 工作过程：在开始传输时将拥塞窗口cwnd设置为1，每收到新报文的确认号，则将拥塞窗口加上MSS的数值。（最大报文段） 同时为了防止cwnd增长过大，为其设置了一个慢启动门限：

> 当 cwnd < ssthresh 时使用慢启动算法
> 当 cwnd > ssthresh 停止使用慢启动而是改用拥塞避免
> 当 cwdn == ssthresh 两种算法都可以

- 拥塞避免: 让cwnd缓慢增大，也就是每经过一个RTT就让发送方的cwnd加1而非加倍。但是需要注意只要出现了拥塞，就必须将慢启动门限ssthresh改为当时发送方窗口的一半（但不能小于2），然后将cwnd设置为1，执行慢启动算法。

![image-20240603005936218](https://lonelywatch-1306651324.cos.ap-beijing.myqcloud.com/image-20240603005936218.png)

- 快重传
 - 如果发送方在超时后未能收到确认报文，则应该尽早减少窗口宽度
 - 每当接收方收到失序报文段，就发送重复确认，一旦发送方收到连续三个重复确认，则重传
- 快恢复
 - 当发送方接收到连续三个重复确认时，就使用乘法减小，将ssthresh减小为当前拥塞窗口的一半，但此时不执行慢启动算法，而是将拥塞窗口设置为ssthresh减半后的数值，直接执行拥塞避免算法。

如果路由器丢弃了分组，或者是包没有收到确认就可以认为发生了拥塞。

![image-20240603010848021](https://lonelywatch-1306651324.cos.ap-beijing.myqcloud.com/image-20240603010848021.png)

#### 连接管理

TCP传输连接有三阶段：

- 连接建立： 采用CS方式，使用**三次握手**：
    1. A向B发送请求报文段,SYN=1，并选择Seq=x表明第一个数据字节序号是x
    2. B收到连接请求后若同意则返回确认，SYN=1,ACK=1, ack确认号为x + 1,自己的seq号为y
    3. A收到后向B确认 ACK=1,确认号ack=y+1

![image-20240603011236325](https://lonelywatch-1306651324.cos.ap-beijing.myqcloud.com/image-20240603011236325.png)

- 数据传送
- 连接释放：
    - 释放可由任一方发起
    1. A发送报文段，其中FIN=1,seq=u
    2. B发出确认，其中ACK=1，ack=u + 1,seq = v
    3. A->B的连接被释放
    4. B向A发送释放报文 FIN = 1,ACK = 1
    5. A发出确认ACK=1，ack=w+ 1,seq = u + 1

![image-20240603011621014](https://lonelywatch-1306651324.cos.ap-beijing.myqcloud.com/image-20240603011621014.png)