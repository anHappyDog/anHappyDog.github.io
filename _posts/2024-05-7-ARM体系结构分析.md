---
title: ARM体系结构分析
author: lonelywatch
date: 2024-05-7 15:14
categories: [ARM]
tags: [ARM,体系结构]  
---

# ARM体系结构分析

## ARM简介

相较于MIPS与RISC-V具有较稳定的指令集和寄存器，ARM发展历程较为复杂，ARM体系结构最早起源于英国的Acorn公司，后来发展为ARM公司，现在则是全球最大的IP提供商之一。ARM体系结构的特点是`RISC`精简指令集，低功耗，高性能，广泛应用于移动设备，物联网，服务器等领域。

ARM从某一阶段开始分为`A`,`R`,`M`三个系列，分别代表应用处理器，实时处理器，微控制器,这三个系列所代表的领域也不同，`A`系列主要用于高性能计算，`R`系列主要用于实时计算，`M`系列主要用于嵌入式系统。

ARM指令集包括`ARM`指令集，`Thumb`指令集，`Thumb-2`指令集，`Thumb-2`指令集是`Thumb`指令集的扩展，支持32位指令集，与`ARM`指令集兼容。ARM架构的版本也有很多，比如`ARMv5`,`ARMv6`,`ARMv7`,`ARMv8`等，在每个大版本中又有多个小版本，每个版本都有不同的特性，`ARMv8`开始支持64位指令集，也就是所谓的`aarch64`，并且也向前兼容原来的`aarch32`。


下面的内容主要基于`ARMv8`(`ARMv8-A`)架构。

## 执行状态

ARMv8有两种执行状态，分别是`AArch32`和`AArch64`，`AArch32`是32位指令集，`AArch64`是64位指令集。`AArch32`是`ARMv7`及之前的指令集，`AArch64`是`ARMv8`新增的指令集。

需要注意的是，执行状态只能在**处理器启动**，或者是**特权级发生变化**时改变。并且如果**某一特权级使用某一执行状态，那么低于他的特权级都使用该执行状态**。

## 安全状态

ARMv8有多种安全状态，分别是`Secure state`和`Non secure state`，如果PE实现了`FEAT_RME`，那么还包括`realm state`与`root state`。

需要注意ARMv8将物理地址空间也分为了`Secure`和`Non secure`两部分，如果PE实现了`FEAT_RME`，那么同样包括`Realm`与`Root`。


## 寄存器

### 通用寄存器

总共有31个通用寄存器，在aarch64中，`X0` ~ `X30`表示64位寄存器，`W0` ~ `W30`表示32位寄存器。需要注意X30是LR寄存器。除此以外还有SP寄存器，PC寄存器，分别表示栈指针寄存器，程序计数器寄存器。

![](https://lonelywatch-1306651324.cos.ap-beijing.myqcloud.com/image-20240713154315746.png)

### PSTATE


### 影子寄存器



### SIMD与FP寄存器

ARMv8具有SIMD与FP寄存器，表示为`V0` ~ `V31`, 和通用寄存器类似，不同位数具有不同的名称，

- `Q0` ~ `Q31` : 128位

- `D0` ~ `D31` : 64位

- `S0` ~ `S31` : 32位

- `H0` ~ `H31` : 16位

- `B0` ~ `B31` : 8位

![](https://lonelywatch-1306651324.cos.ap-beijing.myqcloud.com/image-20240713154239576.png)

`FPCR`寄存器用于控制浮点运算的行为，`FPSR`寄存器用于存储浮点运算的状态。

### SVE 拓展

ARMv8具有SVE拓展，拥有32个SVE 向量寄存器，表示为`Z0` ~ `Z31`，每个寄存器等长，长度最小为128位，最长长度取决于CPU设计。

`P0` ~ `P15`表示SVE的精度寄存器。



## 指令集


## 特权级

ARMv8主要有四种特权级，分别是`EL0`,`EL1`,`EL2`,`EL3`,可以看做成:

- EL3：Secure Monitor 模式，通常用于管理 Secure 和 Non-Secure 状态之间的切换。

- EL2：Hypervisor 模式，用于虚拟化管理。

- EL1：内核模式，用于操作系统内核。

- EL0：用户模式，用于用户态应用程序。



有这么几个点需要注意：

- PE必须实现`EL0`和`EL1`。如果实现了FEAT_RME,则需要实现`EL2`和`EL3`

- `EL2`对`EL0`和`EL1`提供了虚拟化支持。

- 特权级发生改变当且仅当：

  - 发生异常或从异常返回

  - 退出Debug状态

  - 处理器重置

  - 在Debug状态且执行DCPSx指令

  - 在Debug状态且执行DRPS指令

 - 所有的异常都有目标EL,这通常由异常本身隐含，或者由系统寄存器配置

 - 异常不能被EL0处理，并且也不能导致进入更低的特权级,并且异常不能前往未被实现的特权级



## 内存管理

### TLB

### MMU

### Cache

## 异常与中断



## 指令集

## 调用惯例

## 参考文献
