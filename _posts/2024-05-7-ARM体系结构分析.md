---
title: ARM体系结构分析
author: lonelywatch
date: 2024-05-7 15:14
categories: [ARM]
tags: [ARM,体系结构]  
---

# ARM体系结构分析

## ARM简介

相较于MIPS与RISC-V具有较稳定的指令集和寄存器，ARM发展历程较为复杂，ARM体系结构最早起源于英国的Acorn公司，后来发展为ARM公司，现在则是全球最大的IP提供商之一。ARM体系结构的特点是`RISC`精简指令集，低功耗，高性能，广泛应用于移动设备，物联网，服务器等领域。

ARM从某一阶段开始分为`A`,`R`,`M`三个系列，分别代表应用处理器，实时处理器，微控制器,这三个系列所代表的领域也不同，`A`系列主要用于高性能计算，`R`系列主要用于实时计算，`M`系列主要用于嵌入式系统。

ARM指令集包括`ARM`指令集，`Thumb`指令集，`Thumb-2`指令集，`Thumb-2`指令集是`Thumb`指令集的扩展，支持32位指令集，与`ARM`指令集兼容。ARM架构的版本也有很多，比如`ARMv5`,`ARMv6`,`ARMv7`,`ARMv8`等，在每个大版本中又有多个小版本，每个版本都有不同的特性，`ARMv8`开始支持64位指令集，也就是所谓的`aarch64`，并且也向前兼容原来的`aarch32`。


下面的内容主要基于`ARMv8`(`ARMv8-A`)架构。

## 执行状态

ARMv8有两种执行状态，分别是`AArch32`和`AArch64`，`AArch32`是32位指令集，`AArch64`是64位指令集。`AArch32`是`ARMv7`及之前的指令集，`AArch64`是`ARMv8`新增的指令集。

需要注意的是，执行状态只能在**处理器启动**，或者是**特权级发生变化**时改变。并且如果**某一特权级使用某一执行状态，那么低于他的特权级都使用该执行状态**。

## 安全状态

ARMv8有多种安全状态，分别是`Secure state`和`Non secure state`，如果PE实现了`FEAT_RME`，那么还包括`realm state`与`root state`。

需要注意ARMv8将物理地址空间也分为了`Secure`和`Non secure`两部分，如果PE实现了`FEAT_RME`，那么同样包括`Realm`与`Root`。


## 寄存器

### 通用寄存器

总共有31个通用寄存器，在aarch64中，`X0` ~ `X30`表示64位寄存器，`W0` ~ `W30`表示32位寄存器。需要注意X30是LR寄存器。除此以外还有SP寄存器，PC寄存器，分别表示栈指针寄存器，程序计数器寄存器。

![](https://lonelywatch-1306651324.cos.ap-beijing.myqcloud.com/image-20240713154315746.png)

### PSTATE


PSTATE寄存器很像X86中的`EFLAGS`寄存器，用于存储程序的状态。该寄存器是对程序状态的描述，包含若干特征位，其中一部分用于程序的进行，其余部分表示系统级的特征位，比如：

- `N` : Negative condition flag

- `Z` : Zero condition flag

- `C` : Carry condition flag

- `V` : Overflow condition flag

0表示条件未满足，1表示条件满足。

下面是关于异常处理的特征位：

- `D` : Debug mask bit

- `A` : SError interrupt mask bit

- `IRQ` : IRQ interrupt mask bit

- `FIQ` : FIQ interrupt mask bit

其中0表示未被屏蔽，1表示被屏蔽。

PSTATE可以在EL0使用`MRS`和`MSR`指令访问。


### 影子寄存器



### SIMD与FP寄存器

ARMv8具有SIMD与FP寄存器，表示为`V0` ~ `V31`, 和通用寄存器类似，不同位数具有不同的名称，

- `Q0` ~ `Q31` : 128位

- `D0` ~ `D31` : 64位

- `S0` ~ `S31` : 32位

- `H0` ~ `H31` : 16位

- `B0` ~ `B31` : 8位

![](https://lonelywatch-1306651324.cos.ap-beijing.myqcloud.com/image-20240713154239576.png)

`FPCR`寄存器用于控制浮点运算的行为，`FPSR`寄存器用于存储浮点运算的状态。

### SVE 拓展

ARMv8具有SVE拓展，拥有32个SVE 向量寄存器，表示为`Z0` ~ `Z31`，每个寄存器等长，长度最小为128位，最长长度取决于CPU设计。

`P0` ~ `P15`表示SVE的精度寄存器。



## 指令集


## 特权级

ARMv8主要有四种特权级，分别是`EL0`,`EL1`,`EL2`,`EL3`,可以看做成:

- EL3：Secure Monitor 模式，通常用于管理 Secure 和 Non-Secure 状态之间的切换。

- EL2：Hypervisor 模式，用于虚拟化管理。

- EL1：内核模式，用于操作系统内核。

- EL0：用户模式，用于用户态应用程序。



有这么几个点需要注意：

- PE必须实现`EL0`和`EL1`。如果实现了FEAT_RME,则需要实现`EL2`和`EL3`

- `EL2`对`EL0`和`EL1`提供了虚拟化支持。

- 特权级发生改变当且仅当：

  - 发生异常或从异常返回

  - 退出Debug状态

  - 处理器重置

  - 在Debug状态且执行DCPSx指令

  - 在Debug状态且执行DRPS指令

 - 所有的异常都有目标EL,这通常由异常本身隐含，或者由系统寄存器配置

 - 异常不能被EL0处理，并且也不能导致进入更低的特权级,并且异常不能前往未被实现的特权级

### 特权指令

- `MRS` : 读取系统寄存器

- `MSR` : 写入系统寄存器






## 内存管理

ARMv8将内存分为Normal和Device两种类型。Normal类型的内存是指用于存储数据的内存，Device类型的内存是指用于设备的内存，比如显存，网卡缓冲区等。
在此基础上，ARMv8又将内存分为Secure和Non-secure两种类型，如果实现了FEAT_RME，则还有Realm和Root两种类型。


### 地址转换

ARMv8同样使用页式内存管理，主要有`VMSAv8-64`与`VMSAv9128`两种方式，两种方式取决于`TCR`寄存器与特权级的取值，这里着重介绍`VMSAv8-64`。




### TLB

### MMU

### Cache

## 异常

异常可分为精确异常与非精确异常，除去SError外，其他都是精确异常。除此以外，异常又可分为同步异常和异步异常，同步异常主要由指令引起，而异步异常主要由中断等事件引起。

异常返回地址被存放在`ELR_ELx`寄存器中(x表示异常前往的特权级)，对于异步异常（比如中断），则是异常发生时PE正在执行的指令地址，对于同步异常，除去产生异常的执行(svc,hvc等三条指令)，则是指向触发该异常的地址，对于产生异常的指令，`ELR_ELx`寄存器则指向下一条指令的地址。


### 异常指令

- `BRK` : 断点指令

- `HLT` : HALT指令

- `HVC` : 产生异常，进入EL2 Hypervisor模式

- `SMC` : 产生异常，进入EL3 Secure Monitor模式

- `SVC` : 产生异常，进入EL1 Kernel模式

---

- `ERET` : 利用当前EL的ELR和SPSR寄存器从异常处理返回

### 异常种类

- 同步异常

- SError

- IRQ

- FIQ

### 异常向量表

当异常发生时，PE会根据前往的特权级选择相应的异常向量表，异常向量表的地址存放在`VBAR_ELx`（Vector Base Address Register）寄存器中。







## 指令集

### 通用寄存器

|名称|位长|编码|描述|
|-|-|-|-|
|$Wn$|32位|0-30|通用寄存器0-30|
|$Xn$|64位|0-30|通用寄存器0-30|
|$WZR$|32位|31|0寄存器|
|$XZR$|64位|31|0寄存器|
|$WSP$|32位|31|当前栈指针寄存器|
|$SP$|64位|31|当前栈指针寄存器|


### aarch64

所有aarch64的指令都是4字节定长，需要注意这么一些事情：

- 寄存器域取值为0-31，0-30表示31个通用寄存器，如果在数据存取指令中使用了31，就表示栈指针寄存器；如果在源寄存器域就表示0，如果在目标寄存器就表示目标被丢弃


- 通用寄存器前`W`表示32位通用寄存器，`X`表示64位寄存器。大小写都可以且敏感，但是同一变量不能大小写混用

- 使用`//`作为注释符号

### aarch32

### 算数指令


### 分支跳转指令

#### 有条件跳转

|注记符|描述|寻址范围|
|---|---|---|
|$B.cond$|条件跳转|+-1MB|
|$BC.cond$|条件一致跳转|+-1MB|
|$CBNZ$|非0跳转|+-1MB|
|$CBZ$|为0跳转|+-1MB|
|$TBNZ$|test位不为0则跳转|+-32KB|
|$TBZ$|test位为0则跳转|+-32KB|

#### 无条件跳转

|注记符|描述|寻址范围|
|---|---|---|
|$B$|无条件跳转|+-128MB|
|$BL$|跳转并链接（地址存入X30）|+-128MB|
|$BLR$|跳转并链接到寄存器|-|
|$BR$|跳转到寄存器指向的地址|-|
|$RET$|返回|-|

### 异常生成和返回指令

|注记符|描述|
|---|---|
|BRK|断点|
|HLT|halt指令|
|HVC|产生目标特权为EL2的异常|
|SMC|产生目标特权为EL3的异常|
|SVC|产生目标特权为EL1的异常|
|ERET|从异常返回|

### 系统寄存器指令

|注记符|描述|
|---|---|
|MRS|将SR值移到GPR|
|MSR|将GPR值写入SR|
|MRRS|将128位SR移到两个邻接的64位GPR|
|MSRR|将两个邻接的GPR移到128位SR种|

### 系统寄存器

|注记符|描述|
|---|---|
|WFI|等待中断发生|
|WFE|等待事件发生|
|SEV|发送事件|
|SEVL|发送local事件|
|YIELD|yield hint|
|TLBI|TLB无效化|
|SYS|系统指令|


### 数据屏障指令

|注记符|描述|
|---|---|
|DMB|数据内存屏障|
|DSB|数据同步屏障|
|ISB|指令同步屏障|

### 数据访问指令



|注记符|描述|
|---|---|
|LDR|加载寄存器|
|LDRB|加载寄存器字节|
|LDRSB|加载寄存器有符号字节|
|LDRH|加载寄存器半字|
|LDRSH|加载有符号板子|
|LDRSW|加载有符号字|
|STR|存寄存器|
|STRB|存字节|
|STRH|存半字|






## 调用惯例

## 参考文献
