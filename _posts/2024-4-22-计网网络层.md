---
title: 计网网络层
author: lonelywatch
date: 2024-4-22 21:28 +0800
categories: [INTERNET]
tags: [INTERNET]  
---

# 计网网络层

网络层向上只提供**灵活简单**，**无连接**，**尽最大努力交付**的数据报服务，不提供服务质量的承诺。

## 网络协议IP

$IP$协议又称$ Kahn-Cerf $协议,由这两位学者提出，这里主要讨论$IPv4$与$IPv6$;$IP$协议通常配合下列协议使用：

- $ARP$: 地址解析协议
- $ICMP$: 网络控制报文协议
- $IGMP$: 网络组控制协议

可以将网络层理解为很多网络组合而成的网络；这需要使用一些中间设备，包括：

- 物理层使用**转发器**
- 链路层使用**网桥**
- 网络层使用**路由器**
- 网络层以上使用**网关**

这些相互连接的网络都使用$IP$协议，屏蔽了各自的硬件差异，可以看作为一个**虚拟互联网络**；下面是在该网络中发送IP数据报的简易流程：

- 发送本机查找自身路由表，如果目标网络在本网络中则**直接交付**，否则根据路由表发送数据报给对应的路由器,这是**间接交付**。
- 路由器重复如上操作，直到不需要再使用其他路由器进行转发，则直接交付给目的主机

### IP地址分类

一个$IP$地址可以看作为 网络号 + 主机号，即
$$

IP地址::={\<网络号\>,\<主机号\>} 

$$:

- 主机号在对应网络号中必须唯一
- 网络号在整个互联网范围内必须唯一

---

这里将IP地址总共划分为5类，如图所示：

![](https://lonelywatch-1306651324.cos.ap-beijing.myqcloud.com/image-20240518010525418.png)

\> - 在A类地址中，网络号可指派的个数为$2^{7} -2$, 因为**网络号为全0表示本网络**，而**全1则表示本地软件的环回测试**；对于主机号，则最大主机数为$2^{24} -2$，**全0表示该主机连接的单个网络地址**，而**全1表示该网络上的所有主机**。
\> - 

$IP$地址都是32位的二进制数，可以使用点分十进制的记法表示，类似`111.111.111.111`。

- 多归属主机：拥有多个不同$IP$地址。

### IP与MAC地址

- $MAC地址$属于最低两层，而$IP地址$则属于网络层及以上，被使用在各自对应层报文首部。
- 在IP层抽象上只能看见IP数据报；在链路层则只能看见MAC帧。

### 数据报格式

![](https://lonelywatch-1306651324.cos.ap-beijing.myqcloud.com/image-20240602152554938.png)

与MAC帧不同，IP数据报只包含首部和数据部分，其中首部主要由20字节的固定字段 与多个可选字段组成。

- Version: 4字节，4表示为IPV4
- IHL: 4字节， IP包的首部长度，单位为4字节，最小5，最大15，故IP首部最长为60字节
- Type of Service： 1字节服务字段
- 总长：2字节表示IP数据报的总长度，故IP包的最大长度为65535字节。
- 标识：2字节，计数器用于区分IP数据包
 - 超过MTU的IP包要分片传输
 - 分片产生的多个包的标识相同，便于重组
- DF:1字节为0表示允许分片
- MF:1字节,为1表示后续还有分片，为0表示最后一个分片
- Fragment offset: 13字节，表示片偏移
- TTL： 1字节，表示IP包可通过路由器数的最大值

### 子网划分

原因： 分类IP地址无法适应互联网的快速发展
将一个网络划分为若干子网，通过子网掩码来进一步表示。

![](https://lonelywatch-1306651324.cos.ap-beijing.myqcloud.com/image-20240602171901467.png)

由此两级地址变成了3级地址，通过子网掩码可以确定子网号和网络地址。

#### 分组转发

路由器的路由表包含了： 目的网络地址，子网掩码，下一跳地址。
转发流程为：
- 提取目的IP
- 首先与直接相连网络与该IP相匹配，若匹配则直接交付，否则间接交付
- 查找路由表，如果存在路由则直接转发
- 匹配路由表项表项，存在则传送给下一跳路由器
- 有默认路由则使用默认路由
- 否则出错

### 超网

`CIDR`全称`Classless Inter-Domain Routing`无分类域间路由，其特点为使用变长网络前缀代替网络号和子网号，由此使用CIDR将IP地址表示为：

![](https://lonelywatch-1306651324.cos.ap-beijing.myqcloud.com/image-20240602172551406.png)

CIDR记法为IP地址后跟随斜线和网络前缀所占位数。

CIDR将网络前缀相同的连续IP地址组成CIDR地址块，由此一个CIDR地址块可以表示很多地址，这种地址聚合称为路由聚合。

好处：减少路由表项和路由交换信息。

路由聚合也被称为超网。使用路由聚合后在匹配路由表时则使用**最长前缀匹配**的方式（因为越长越具体）。

## ARP协议

- ARP协议主要用于将IP地址转化为物理地址，并且ARP帧以广播的形式发送。
- 主机本身带有ARP缓存，存储IP地址向硬件地址的映射表

当向局域网中的主机B发送IP包时
- 首先查询ARP cache是否由B的IP地址
- 有则查找硬件地址，并写入MAC帧发送
- 无则广播ARP请求，发送ARP请求报文
- 当B收到ARP请求报文时，给A返回一个ARP应答报文，告知自己的物理地址

如果主机不在同一局域网中，则需要经过路由器转发。

## ICMP协议

主要用于报告出错和测试等控制信息，位于网络层，封装在IP包中。总共类型有9中，可分为差错报告报文和询问报文。


## 路由算法与协议

路由协议使用路由算法生成路由信息，路由算法具有静态路由和动态路由两种路由策略，动态路由算法主要有**距离向量**和**链路状态**两种。

自治系统：单一技术管理下的一组路由器。由此可将路由协议分为

-**内部网关协议**：AS内部所使用，比如RIP和OSPF。
-**外部网关协议**：用于AS之间交换路由信息。

### RIP协议

- 距离路由算法在每个路由器中维护一张表，记录到每个目的地的已知最佳距离和线路，并与相邻路由器交换距离信息。
- 周期性向邻居发送其路由表，并接受其他路由器的路由表。
- 取距离最小值，并更新路由器。


RIP协议属于动态路由协议，使用距离向量路由算法，其中的距离为路由器跳数，最大15；16表示不可达。

- 优点：简单且便于计算，适用于小型网络

![image-20240603085247717](https://lonelywatch-1306651324.cos.ap-beijing.myqcloud.com/image-20240603085247717.png)

### OSPF协议

OSPF基于链路状态，动态地交换链路状态信息，也就是说：
- 发现邻居节点并测量其链路状态
- 将所得发送给其他所有AS内路由器
- 计算最短路径

有点： 收敛速度快，适用于较大规模的网络。

OSPF将AS分成了若干area区域，每个区域都有一个32位的标识符。这样使用泛洪法交流链路信息则仅限于一个区域。其中上层的区域称为**主干区域**，其标识符规定为0.0.0.0。

![image-20240603090120992](https://lonelywatch-1306651324.cos.ap-beijing.myqcloud.com/image-20240603090120992.png)

![image-20240603090203529](https://lonelywatch-1306651324.cos.ap-beijing.myqcloud.com/image-20240603090203529.png)


### BGP协议



## IP组播

使用D类IP地址作为组播地址

## NAT与VPN

![image-20240603090719314](https://lonelywatch-1306651324.cos.ap-beijing.myqcloud.com/image-20240603090719314.png)

NAT路由器内部使用TCP/UDP端口号实现外网数据包向内网地址的转换