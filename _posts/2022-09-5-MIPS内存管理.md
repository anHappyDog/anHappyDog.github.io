---



---

所用图片大多摘自See mips run Linux.

### 通用寄存器

![image-20240211181439010](https://lonelywatch-1306651324.cos.ap-beijing.myqcloud.com/image-20240211181439010.png)

### 协处理器

表示处理器的一个可选部件，处理ISA的某个扩展，用来处理中断，提供配置以及Cache和时钟等功能。MIPS预留了4个协处理器。

CP0就是系统控制协处理器，CP1就是浮点协处理器。

#### CP0

提供了若干寄存器，`mtc0|mfc0`用于写读。下面是一些CP0中重要的寄存器名和标号。

- SR (12) : 状态寄存器，大多为控制位。
- CAUSE (13) : 异常的原因
- EPC (14) ： 异常返回地址
- COUNT (9) : MIPS计时器
- COMPARE (11) : 和COUNT一起构成时钟，如果COUNT >= COMPARE 则会触发时钟中断
- BAD_VADDR (8) : 触发异常的值
- ENTRY_HI (10) : 
- ENTRY_LO   0-1 (2-3):

#### SR寄存器

![image-20240211203751020](https://lonelywatch-1306651324.cos.ap-beijing.myqcloud.com/image-20240211203751020.png)

- RE : 表示大小尾端

- BEV : 为1表示启用KSEG1中的异常入口
- SR : 异常开启。
- IM7-0 : 中断屏蔽位,其中0，1位Cause可写的软件中断，其他为外部中断。
- KSU : 特权位 ： 0为内核态，1为监督者，2为用户态。

- IE : 全局中断使能

#### CAUSE寄存器 

![image-20240211204249585](https://lonelywatch-1306651324.cos.ap-beijing.myqcloud.com/image-20240211204249585.png)

- TI : 时钟中断发生则置位。
- DC : 写为1则停止Count寄存器，可以减少功耗。
- IV : 写为1 则使用一个特殊的中断异常入口地址。
- IP7-0：发生了哪些中断。
- ExcCode：表示异常的种类，如下表:

![image-20240211204541995](https://lonelywatch-1306651324.cos.ap-beijing.myqcloud.com/image-20240211204541995.png)

### 计时器

COUNT寄存器为32位，一旦溢出则置为0，当COUNT值等于COMPARE值时，发生中断且会一直保持，直到COMPARE后续的值被写入，中断才会消除。

需要注意，COMPARE的数值可能会由于中断处理的延迟而被COUNT超过，所以需要在COMPARE写后重新读入COUNT的值，并作相应处理。

#### CONFIG 寄存器

配置选项寄存器：

![image-20240211205007989](https://lonelywatch-1306651324.cos.ap-beijing.myqcloud.com/image-20240211205007989.png)

- AT : 0 为MIPS32,1为MIPS64,但是使用MIPS32的地址映射；2为使用MIPS64.
- BE : 1为大尾端，0为小尾端。

### MIPS32 地址布局

![image-20240211202728468](https://lonelywatch-1306651324.cos.ap-beijing.myqcloud.com/image-20240211202728468.png)

| 名称  |           地址            |      说明      |
| :---: | :-----------------------: | :------------: |
| kuseg |      0x0~0x7fff_ffff      | 用户模式下地址 |
| kseg0 | 0x8000_0000 ~ 0x9fff_ffff |  非映射，缓存  |
| kseg1 | 0xA000_0000 ~0x bfff_ffff | 非映射，非缓存 |
| kseg2 | 0xc000_0000 ~ 0xffff_ffff |      映射      |

- 对于kuseg，如果开启了MMU则通过MMU转换，否则由具体实现而定。
- kseg0中的地址清零最高1位得到物理地址， 并且使用Cache，一般放置内核代码。
- kseg1中的地址清零最高3位得到物理地址，不使用Cache，需要注意启动的入口向量在0xbfc0_0000，物理地址为0x1fc0_0000.
- kseg2 只能在内核态使用，并且需要使用MMU进行地址转换。

### MIPS64 地址布局

![image-20240211202756827](https://lonelywatch-1306651324.cos.ap-beijing.myqcloud.com/image-20240211202756827.png)

![asdad](https://lonelywatch-1306651324.cos.ap-beijing.myqcloud.com/image-20240211202756827.png)

### Cache

使用SDRAM,是一个相联存储器，其中的数据按簇存放，可以理解为一个HASH，键为完整的内存地址，而值则是对应的地址。

Cache主要有直接映射，组相联，全相联这么几种。使用写回 来解决需要保持数据一直而降低速率的问题。（设置D位和A位）

并且可以有多级Cache。

#### Cache操作和指令

- 无效地址范围内的Cache项
- 写回地址范围内的Cache项
- 无效所有Cache项
- 初始化Cache